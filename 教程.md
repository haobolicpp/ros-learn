# 1. ros安装
- 安装过程参考<https://www.cnblogs.com/letisl/p/11815191.html>
- 安装wsl略，利用mobaxterm进行连接与可视化。
## 1.1. 添加源
`sudo sh -c '. /etc/lsb-release && echo "deb http://mirrors.ustc.edu.cn/ros/ubuntu/ $DISTRIB_CODENAME main" > /etc/apt/sources.list.d/ros-latest.list'`  
## 1.2. 添加私钥
`wget https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -O - | sudo apt-key add -` 
打不开则： 
`sudo apt-key adv --keyserver hkp://pool.sks-keyservers.net --recv-key 0xB01FA116` 
## 1.3. 更新软件列表
 `sudo apt-get update`，会报GPG错误，解决办法是添加公钥：`sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F42ED6FBAB17C654`
## 1.4. 安装ros
`sudo apt-get install ros-melodic-desktop-full`  
安装目录在/opt/ros下。
## 1.5. 初始化
`sudo rosdep init`  
`rosdep update`  
### 1.5.1. 问题1
提示：`sudo rosdep：找不到命令提示`，执行下面指令：  
`sudo apt install python-rosdep`  
### 1.5.2. 问题2
提示：`ERROR: cannot download default sources list from:
https://raw.githubusercontent.com/ros/rosdistro/master/rosdep/sources.list.d/20-default.list
Website may be down.`  
- 解决办法1：  
打开`https://site.ip138.com/raw.Githubusercontent.com/`，输入raw.githubusercontent.com查询出一个可用的ip地址，然后在/etc/hosts文件最后添加：  
`199.232.28.133 raw.githubusercontent.com`  
`151.101.228.133 raw.github.com`  
结果可能不行，此时参考方法2.  
- 解决办法2：  
a.利用代理手段翻墙(可以直接拷贝此处的链接)，打开链接https://raw.githubusercontent.com/ros/rosdistro/master/rosdep/sources.list.d/20-default.list，拷贝其中的内容：  
`#os-specific listings first`  
`yaml https://raw.githubusercontent.com/ros/rosdistro/master/rosdep/osx-homebrew.yaml osx`  
`# generic`  
`yaml https://raw.githubusercontent.com/ros/rosdistro/master/rosdep/base.yaml`  
`yaml https://raw.githubusercontent.com/ros/rosdistro/master/rosdep/python.yaml`  
`yaml https://raw.githubusercontent.com/ros/rosdistro/master/rosdep/ruby.yaml`  
`gbpdistro https://raw.githubusercontent.com/ros/rosdistro/master/releases/fuerte.yaml fuerte`  
`# newer distributions (Groovy, Hydro, ...) must not be listed anymore, they are being fetched from the rosdistro index.yaml instead` 
b.创建目录，新建文件20-default.list，将内容拷贝到文件中    
`sudo mkdir -p /etc/ros/rosdep/sources.list.d`  
`touch /etc/ros/rosdep/sources.list.d/20-default.list`  
c.执行`rosdep update`
## 1.6. 环境变量配置
放到~/.bashrc文件最后  
 `source /opt/ros/melodic/setup.bash`  
 ~~`source ~/ros_temp/catkin_ws/devel_isolated/setup.sh`~~    
 然后执行`source ~/.bashrc`
## 1.7. 安装rosinstall
`sudo apt-get install python-rosinstall python-rosinstall-generator python-wstool build-essential`  
~~安装ros插件`sudo apt install ros-melodic-jsk-rviz-plugins`~~
## 1.8. 测试小乌龟
- 启动roscore `roscore &`
- `rosrun turtlesim turtlesim_node`
## 1.9. 测试rviz
`rosrun rviz rviz`，发现报段错误，需要将`export LIBGL_ALWAYS_INDIRECT=`添加到.bashrc文件最后。
## 1.10. 卸载ros
`sudo apt-get remove ros-melodic-*`

# 2. 注意注意
>`建议启动新的节点时，将roscore重启一下，防止莫名其妙的错误！！`

# 3. 创建工作空间与功能包
> ros的工作空间是我们开发ros项目的一个工作目录  
> - src:代码空间，包含代码、lanuch文件、配置文件等等，是源码所在的目录；  
> - build:编译空间，包含编译过程中产生的中间文件；
> - devel:开发空间，编译生成的可执行文件、库等等；
> - install:安装空间，用install命令安装的文件放置的位置（开发基本用不到）。  
## 3.1. 创建工作空间
  ```
  mkdir -p ~/catkin_ws/src 
  cd ~/catkin_ws/src
  catkin_init_workspace
  ```
## 3.2. 编译工作空间
  `cd ~/catkin_ws`  
  `catkin_make`或`catkin_make install`，后者会将可执行文件放入install文件夹
## 3.3. 设置环境变量
在.bashrc最后添加：    
  `source ~/catkin_ws/devel/setup.bash`   
  `source ~/.bashrc`
## 3.4. 检查环境变量
  `echo $ROS_PACKAGE_PATH`
## 3.5. 创建功能包
 功能包是放置代码的最小单元    
  `cd ~/catkin_ws/src`  
  `catkin_create_pkg test_pkg std_msgs roscpp`(catkin_create_pkg<功能包名>[依赖1][依赖2])
## 3.6. 编译功能包
  ```
  cd ~/catkin_ws
  catkin_make
  ```
## 3.7. 编译指定的功能包
- 当src下包比较多时，编译检查会非常慢，可以在某个包内创建文件夹`CATKIN_IGNORE`，此时该包会被跳过。
- 利用指令：`catkin_make -DCATKIN_WHITELIST_PACKAGES="源码存放的文件夹名字"`来编译指定的功能包，执行该指令后，再执行catkin_make还会编译那个包，如果编译所有包则执行`catkin_make -DCATKIN_WHITELIST_PACKAGES=""`。

# 4. 话题
## 4.1. 发布与订阅
 - 容易理解的是，话题是节点与节点之前通信的一种方式，（服务是节点之间通信的另一种方式）  
 - 话题与服务的区别是：   
   **节点只管投递，数据可能会丢失；**
   **服务会有request和response,相当于RPC调用。**  
   **话题用.msg文件定义数据，服务用.srv文件定义数据**  
 - 代码示例：  
 1、pos_subscriber和velocity_publisher是订阅和发布ros系统已有的一个话题；利用`advertise()`创建发布者对象。  
 2、person_pubsher和person_subscriber是自定义了一个话题来进行测试。利用`subscribe()`创建订阅者对象。  
  
## 4.2. 自定义话题消息
 - 创建Xxx.msg文件，和编程语言无关，建议放到src同级目录，统一叫msg的文件夹中,首字母大写
 - 在package.xml中添加创建message的功能包依赖  
 `<build_export_depend>message_generation</build_export_depend>`  
 `<exec_depend>message_runtime</exec_depend>`   
 - CMakeList.txt中添加编译选项（针对创建message的依赖包）  
 `find_package(... message_generation)`  
 `add_message_files(FILES Xxx.msg)`  
 `generate_messages(DEPENDENCIES std_msgs)`  
 `catkin_package(...message_runtime)`
 - 编译，生成消息对应的.h文件

# 5. 服务
## 5.1. 客户端与服务
 - **客户端**：参考test_service包中turtle_spawn.cpp，其中会向服务/spawn发送请求数据，并显示应答信息。利用`serviceClient()`创建通信对象。  
 也可以参考test_param包中param_config.cpp，直接调用`call()`接口。  
 - **服务端**：参考test_service包中的turtle_command_srv.cpp，其中自定义服务对象，接收一个系统定义格式的数据，收到数据后进行处理。利用`advertiseService()` 创建服务对象。使用时可以通过`rosservice`指令查看当前的服务信息，`rosservice call`来传递消息给服务.

## 5.2. 自定义服务数据
 - 创建Xxx.srv文件，文件中`---`分割线表示上面是请求request的数据格式，下面是response响应的数据格式。   
 - 在package.xml中添加创建message的功能包依赖(同上)  
 -  CMakeList.txt中添加编译选项（针对创建srv的依赖包）（同上）,改为add_service_files  
 - 编译，生成消息对应的.h文件  


# 6. 参数服务Parameter Server （全局字典）
    使用命令rosparam操作变量,参考上面。ROS用的是YAML格式文件。  
    参考test_param包。


# 7. ros中坐标系管理系统
 - **【 原理 】（重要）** ： 通过tf包的发布功能，可以发布一组坐标之间的转换关系（平移+旋转）， 构建一个树形结构，然后通过lookupTransform()接口可以获取任意两个坐标之间的转换关系，不用自己再计算了，强大！！`即通过tf广播器广播坐标映射关系，通过tf监听器得到任意两个坐标系之间的关系`  
 - **创建坐标映射**  
 `static tf::TransformBroadcaster tfb;`  
 `tfb.sendTransform(tf::StampedTransform(tr, ros::Time::now(), "world", strTurtlename));`  
 - **获取坐标映射**  
 `tf::TransformListener listener;`  
 `tf::StampedTransform tr;`
 `listener.waitForTransform("/turtle2", "/turtle1", ros::Time(0), ros::Duration(3.0)); //从当前时间开始，等待一段时间3s，没有数据应该会异常（猜的），有数据返回`  
 `listener.lookupTransform("/turtle2", "/turtle1", ros::Time(0), tr); //获取转换关系`  
 - **rosrun tf view_frames** ： tf功能包中的一个工具，监听一段时间，5s内所有坐标系之间的关系保存成pdf文件。其中展示tf树，表示有多少个坐标系及他们之间的关系。  
 - **rosrun tf tf_echo 坐标系1 坐标系2** ： 实时打印两个坐标系之间的关系:  
 `Translation: [-0.000, -0.000, 0.000]` 表示坐标系之间的平移向量  
 `Rotation: in Quaternion [0.000, 0.000, 0.599, 0.801]` 表示坐标系之间的旋转向量，本行是四元数方式[x,y,z,w]  
 `in RPY (radian) [0.000, -0.000, 1.284]` 弧度表示，表示每个轴旋转的角度
 `in RPY (degree) [0.000, -0.000, 73.549]`  度表示，表示每个轴旋转的角度  
 - **可视化工具rviz：rosrun rviz rviz -d `rospack find turtle_tf` /rviz/turtle_rviz.rviz**  


# 8. launch启动文件


# 9. 可视化工具介绍

# 10. ROS-Navigation
官方链接：<http://wiki.ros.org/navigation>
## 10.1. 安装方式
方式一，通过apt-get安装编译好的包；  
方式二，通过源码编译安装--推荐。会安装如下包：
> -- ~~  traversing 16 packages in topological order:  
-- ~~  - navigation (metapackage)  
-- ~~  - map_server  
-- ~~  - amcl  
-- ~~  - fake_localization  
-- ~~  - voxel_grid  
-- ~~  - costmap_2d  
-- ~~  - nav_core  
-- ~~  - base_local_planner   
-- ~~  - carrot_planner  
-- ~~  - clear_costmap_recovery  
-- ~~  - dwa_local_planner  
-- ~~  - move_slow_and_clear  
-- ~~  - navfn  
-- ~~  - global_planner  
-- ~~  - rotate_recovery  
-- ~~  - move_base  

## 10.2. 源码安装
- 下载地址  
`https://github.com/ros-planning/navigation/tree/melodic-devel`
- 拷贝到`~/catkin_ws/src`下面
- 执行安装  
  `cd ~/catkin_ws/`  
  `catkin_make`  
  编译报错“Could NOT find SDL”，执行指令`sudo apt-get install libsdl1.2-dev`  
  编译报错“Could NOT find SDL_image”，执行指令`sudo apt-get install libsdl-image1.2-dev`  
  编译报错“Could NOT find tf2_sensor_msgs”，需要下载该包进行编译，地址<https://github.com/ros/geometry2/tree/melodic-devel>，拷贝到`~/catkin_ws/src`下面继续安装。  
  编译报错“Could NOT find move_base_msgs”，需下载该包进行编译，地址<https://github.com/ros-planning/navigation_msgs>，拷贝到`~/catkin_ws/src`下面继续安装。
  编译报错“mmap: Cannot allocate memory”，重新编译即可。  
## 安装teb_local_planner插件
>传统的navigation里的路径规划策略性能不佳。在尝试了teb_local_planner后，发现机器人导航性能得到非常大的提升。  
>为了编译时不再检查前面装的包，可以在前面包源码目录下新建CATKIN_IGNORE文件夹。
- 下载链接<https://github.com/rst-tu-dortmund/teb_local_planner>
- 拷贝到`~/catkin_ws/src`，执行`catkin_make"`进行编译。  
  a. 编译报错“Could NOT find costmap_converter”，下载链接<https://github.com/rst-tu-dortmund/costmap_converter>，拷贝到`~/catkin_ws/src`下面继续安装。  
  b. 编译报错“Could NOT find mbf_costmap_core”，下载链接<https://github.com/magazino/move_base_flex/tree/melodic>,拷贝到`~/catkin_ws/src`下面继续安装。   
  c. 编译报错“unable to find SuiteSparse”，执行`sudo apt-get install libsuitesparse-dev`。  
  e. 编译报错“Could not find libg2o!”，这里选择源码安装libg2o图优化库：  
    >首先下载该库：<https://github.com/RainerKuemmerle/g2o>  
    >安装依赖:(cmake已经安装) `sudo apt-get install libeigen3-dev libeigen3-doc`  
    >编译：  
    `cd g2o-master`  
    `mkdir build`  
    `cd build`  
    `cmake ../`   
    `make`  
     
- 注意，teb_local_planner源码中关于plugin的配置文件均已写好，直接编译源码就能完成plugin的注册及插入，非常方便。

# 11. 常用的指令
## 11.1. **ros相关，rosxxx**
 - **roscore** : 启动ros服务，一般是roscore &   
 - **rosnode** : 查看节点信息，后可接指令：cleanup info kill list machine ping  
     `rosnode info /xxx` ： 查看节点详细信息，包括发布数据的队列、订阅数据的队列、服务、连接信息等等。
 - **rosrun** ： 运行某个节点，(`rosrun 包 节点 [参数]`)  
 - **rosmsg** : rosmsg is a command-line tool for displaying information about ROS Message types.是一个显示ROS话题数据类型的命令工具  
 （`rosmsg show MSG` 显示指定的消息信息）  
 - **rossrv** ：rossrv is a command-line tool for displaying information about ROS Service types.是一个显示ROS服务数据类型的命令工具
 （`rossrv show SRV`：展示SRV的具体格式信息）  
 （`rossrv list`：展示所有的服务类型列表）
 - **rostopic** ： 话题操作指令  
 (`rostopic list` 打印topic列表)  
 (`rostopic pub [-r 频率] /xxx话题 数据类型 数据` 给指定的topic输入数据，这里数据类型+数据用tab键自动补全, 可选的-r是发送的频率，如果没有则只发送一次。)    
 - **rosservice** : 服务操作指令  
 (`rosservice list`列出当前所有的服务)  
 (`rosservice call /xxx "{}"`调用某个服务并传入某些参数,可tab给出参数)；  
 - **rosparam** : 针对参数服务的操作指令。  
 (`rosparam list`列出当前所有参数)  
 (`rosparam get param_key`显示某个参数值)  
 (`rosparam set param_key param_value`设置某个参数值)  
 (`rosparam dump file_name`保存参数到文件)  
 (`rosparam load file_name`从文件读取参数)  
 (`rosparam delete param_key`删除参数)  
 - **rosbag** : 话题数据记录工具指令，记录当前所有话题的数据，来进行数据回放仿真用。  
 (`rosbag record -a -O xxx文件` 开始记录，保存到文件xxx中)  
 (`rosbag play xxx文件` 播放文件中的内容，重现)  
 - **rospack** : (`rospack find move_base` #寻找move_base包的位置)
## 11.2. **catkin_相关**
 - catkin_create_pkg ：cd到src/目录下，执行"catkin_create_pkg 创建的包 依赖包"，**这里需要依赖包，不然不会生成src和include目录**。  
 - catkin_make : 在工作空间根目录下，调用后会对src中的所有项目进行编译
## 11.3. 其他命令工具
 - **rqt_graph** : 列出当前正在运行的节点node，以及它们之间的通讯关系。  
 - **d**
